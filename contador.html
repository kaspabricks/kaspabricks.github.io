<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Contador Kaspa % Transparente</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;       /* evita scroll */
    height: 100%;
    background: black;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  canvas {
    display: block;
    /* Sin width/height en CSS para evitar distorsión */
  }
</style>
</head>
<body>

<canvas id="canvas"></canvas>

<script>
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  const fondo = new Image();
  fondo.src = 'fondo.jpg';  // Imagen base 1024x1024

  const anguloGrados = -4;
  const anguloRad = anguloGrados * Math.PI / 180;

  const WALLET = 'kaspa:qrg43uan89750atpur08ljvlxv36gyf82gy3hf5zq0h0urcsjlfsvk473y4wr';
  const API_URL = `https://api-v2-private.kas.fyi/addresses/${WALLET}/info`;
  const MAX_KASPA = 100000;

  let currentTexto = '...';

  function resizeCanvas() {
    // Elegimos el lado menor de la ventana para mantener el canvas cuadrado
    const size = Math.min(window.innerWidth, window.innerHeight);
    canvas.width = size;
    canvas.height = size;

    actualizarCanvas(currentTexto);
  }

  fondo.onload = () => {
    resizeCanvas();
    actualizarBalance();
    setInterval(actualizarBalance, 60000);
  };

  window.addEventListener('resize', resizeCanvas);

  async function actualizarBalance() {
    try {
      const res = await fetch(API_URL);
      if (!res.ok) throw new Error('Error al consultar la API');

      const data = await res.json();
      console.log('Datos API:', data);

      let balance = 0;
      if (data.balance) {
        balance = Number(data.balance) / 100000000;
      }
      if (isNaN(balance)) balance = 0;

      const porcentaje = (balance / MAX_KASPA) * 100;
      console.log('Balance Kaspa:', balance);
      console.log('Porcentaje:', porcentaje);

      actualizarCanvas(porcentaje.toFixed(2));
    } catch(e) {
      console.error('Error:', e);
      actualizarCanvas('Err');
    }
  }

  function actualizarCanvas(texto) {
    currentTexto = texto;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Dibuja fondo escalado sin deformar (igual al canvas cuadrado)
    ctx.drawImage(fondo, 0, 0, canvas.width, canvas.height);

    // Posición proporcional dentro del canvas
    const x = canvas.width * 0.35;
    const y = canvas.height * 0.43;

    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(anguloRad);

    const fontSize = Math.floor(canvas.width * 0.17);
    ctx.font = `${fontSize}px Impact`;
    ctx.textBaseline = 'top';

    const offsetX = parseFloat(texto) < 10 ? fontSize * 0.33 : 0;

    ctx.globalCompositeOperation = 'destination-out';
    ctx.fillText(texto + '%', offsetX, 0);
    ctx.restore();

    ctx.globalCompositeOperation = 'source-over';
  }
</script>

</body>
</html>
