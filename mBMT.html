<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FAP monkey adventures vs BTC Maxis (Mobile)</title>
<style>
  body { margin:0; overflow:hidden; background:#000; touch-action: none; }
  canvas { display:block; }
  
  #musicBtn {
    position:absolute; top:10px; right:10px; z-index:1000;
    padding:12px 18px; font-size:24px; cursor:pointer; border-radius:12px;
    border:2px solid white; background:rgba(0,0,0,0.6); color:white;
  }
  #musicBtn:hover { background:rgba(255,255,255,0.2); }

  /* Botones táctiles */
  #mobileControls {
    position:absolute; bottom:20px; left:0; right:0; display:flex; justify-content:space-around; z-index:1000;
  }
  .controlBtn {
    width:80px; height:80px; border-radius:50%; background:rgba(255,255,255,0.2); border:2px solid white;
    font-size:36px; color:white; display:flex; justify-content:center; align-items:center; user-select:none;
    -webkit-user-select:none; touch-action:none;
  }
</style>
</head>
<body>

<canvas id="game"></canvas>
<button id="musicBtn">Music On</button>

<!-- Controles táctiles -->
<div id="mobileControls">
  <div class="controlBtn" id="leftBtn">◀️</div>
  <div class="controlBtn" id="jumpBtn">⬆️</div>
  <div class="controlBtn" id="rightBtn">▶️</div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const WORLD_WIDTH = 2000;

// ---------- IMÁGENES ----------
const playerGif = new Image(); playerGif.src = "monito.gif";
const enemySprite = new Image(); enemySprite.src = "mario.png";
const bossSprite = new Image(); bossSprite.src = "MS.png";
const bgDefault = new Image(); bgDefault.src = "fondo.jpg";
const bgFlash = new Image(); bgFlash.src = "saylorloco.jpg";
const winImg = new Image(); winImg.src = "win.png";
let currentBg = bgDefault;

// ---------- AUDIO ----------
const monitoSound = new Audio("monito.mp3");
const damageSound = new Audio("damage.mp3");
const bgMusic = new Audio("jumanji.mp3"); bgMusic.loop=true; bgMusic.volume=0.3;
const bossSound = new Audio("second.mp3");
const winSound = new Audio("risa.mp3");

// ---------- CONFIG ----------
const GRAVITY = 0.6; // un poco más ligero
let cameraX = 0;
let survivalTime = 0;
let killCount = 0;
let boss = null;
let bossAppeared = false;
let invincible = false;
let win = false;
let gameOver = false;

// ---------- SCREEN SHAKE ----------
let screenShake = false;
let shakeEndTime = 0;

// ---------- PLAYER ----------
let player = {
  x: 100, y: 0, w: 50, h: 50,
  originalW:50, originalH:50,
  vx:0, vy:0, speed:5, jumpPower:14,
  grounded:false, facing:1
};

// ---------- INPUT ----------
const keys = {};
function addTouchKey(key, btn){
  btn.addEventListener("touchstart", e=>{ e.preventDefault(); keys[key]=true; });
  btn.addEventListener("touchend", e=>{ e.preventDefault(); keys[key]=false; });
  btn.addEventListener("touchcancel", e=>{ e.preventDefault(); keys[key]=false; });
}

addTouchKey("ArrowLeft", document.getElementById("leftBtn"));
addTouchKey("ArrowRight", document.getElementById("rightBtn"));
addTouchKey(" ", document.getElementById("jumpBtn"));

// ---------- TECLADO PARA TEST ----------
window.addEventListener("keydown", e=>keys[e.key]=true);
window.addEventListener("keyup", e=>keys[e.key]=false);

// ---------- PLATAFORMAS ----------
const platforms = [
  {x:0, y:450, w:2000, h:50},
  {x:300, y:350, w:200, h:20},
  {x:650, y:300, w:200, h:20},
  {x:1200, y:330, w:200, h:20}
];
const walls = [{x:-50, y:0, w:50, h:500},{x:2000, y:0, w:50, h:500}];

// ---------- ENEMIGOS ----------
let enemies = [];
let lastEnemySpawn = Date.now();

// ---------- COLLISION ----------
function aabb(a,b){
  return a.x<a.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y;
}
function resolveCollision(entity, platform){
  if(!aabb(entity, platform)) return;
  const dxLeft = entity.x+entity.w-platform.x;
  const dxRight = platform.x+platform.w-entity.x;
  const dyTop = entity.y+entity.h-platform.y;
  const dyBottom = platform.y+platform.h-entity.y;
  const minX=Math.min(dxLeft,dxRight);
  const minY=Math.min(dyTop,dyBottom);
  if(minX<minY){
    if(entity.x<platform.x) entity.x=platform.x-entity.w;
    else entity.x=platform.x+platform.w;
    entity.vx=0;
  } else {
    if(entity.vy>0){ entity.y=platform.y-entity.h; entity.vy=0; entity.grounded=true; }
    else if(entity.vy<0){ entity.y=platform.y+platform.h; entity.vy=0; }
  }
}

// ---------- PLAYER UPDATE ----------
function updatePlayer(){
  if(keys["ArrowRight"]) { player.vx=player.speed; player.facing=1; }
  else if(keys["ArrowLeft"]) { player.vx=-player.speed; player.facing=-1; }
  else player.vx*=0.8;

  if((keys["ArrowUp"] || keys[" "] || keys["w"]) && player.grounded){
    player.vy=-player.jumpPower; player.grounded=false; beep(300,0.08);
  }

  player.vy+=GRAVITY;
  player.x+=player.vx; player.y+=player.vy;
  player.grounded=false;

  for(const p of platforms) resolveCollision(player,p);
  for(const w of walls) resolveCollision(player,w);

  if(player.y>canvas.height+200){ gameOver=true; beep(80,0.6); }

  cameraX=Math.max(0, Math.min(WORLD_WIDTH-canvas.width, player.x-canvas.width/2));
}

// ---------- RESIZE CANVAS ----------
function resizeCanvas(){
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

// ---------- LOOP ----------
let lastTime=performance.now();
function loop(){
  const now=performance.now();
  const delta=(now-lastTime)/1000;
  lastTime=now;

  if(!gameOver && !win){
    survivalTime+=delta;
    updatePlayer();
  }

  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// ---------- DRAW ----------
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(currentBg.complete) ctx.drawImage(currentBg,0,0,canvas.width,canvas.height);

  ctx.save();
  let shakeX=0, shakeY=0;
  if(screenShake){ const intensity=6; shakeX=(Math.random()-0.5)*2*intensity; shakeY=(Math.random()-0.5)*2*intensity; }
  ctx.translate(-cameraX+shakeX,shakeY);

  ctx.fillStyle="#654321";
  for(const p of platforms) ctx.fillRect(p.x,p.y,p.w,p.h);
  ctx.fillStyle="#333";
  for(const w of walls) ctx.fillRect(w.x,w.y,w.w,w.h);

  for(const e of enemies) if(enemySprite.complete) ctx.drawImage(enemySprite,e.x,e.y,e.w,e.h);
  if(boss && bossSprite.complete) ctx.drawImage(bossSprite,boss.x,boss.y,boss.w,boss.h);

  if(playerGif.complete && !win){
    ctx.save();
    ctx.translate(player.x+player.w/2, player.y+player.h/2);
    ctx.scale(player.facing,1);
    ctx.drawImage(playerGif,-player.w/2,-player.h/2,player.w,player.h);
    ctx.restore();
  }

  ctx.restore();

  ctx.fillStyle="white"; ctx.font="20px Arial";
  ctx.fillText(`Time: ${Math.floor(survivalTime)}s`,20,30);
  ctx.fillText(`Jars: ${killCount}`,20,60);
}

// ---------- BEEP ----------
function beep(freq,duration=0.1){
  const ctx=new AudioContext();
  const o=ctx.createOscillator();
  const g=ctx.createGain();
  o.connect(g); g.connect(ctx.destination);
  o.frequency.value=freq; o.type="square"; g.gain.value=0.1;
  o.start(); o.stop(ctx.currentTime+duration);
}

// ---------- MUSIC ----------
document.getElementById("musicBtn").addEventListener("click",()=>{
  if(bgMusic.paused){ bgMusic.play(); musicBtn.textContent="Music On"; }
  else { bgMusic.pause(); musicBtn.textContent="Music Off"; }
});

// ---------- AUTO PLAY MUSIC EN MOBILE ----------
document.body.addEventListener("keydown",()=>bgMusic.play(),{once:true});
document.body.addEventListener("click",()=>bgMusic.play(),{once:true});
document.body.addEventListener("touchstart",()=>bgMusic.play(),{once:true});
</script>
</body>
</html>
